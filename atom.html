<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NIDS v2.0</title>
  <!-- Leaflet & PapaParse -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="author" content="PSSg Leong, RAC - PIDMU, NOrPPO, PRO NIR" />
  <style>
    :root{--bg:#121212; --panel:#1f1f1f; --muted:#777; --accent:#00bfff; --gold:#ffcc00; --card:#222;}
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:Inter,Arial,Helvetica,sans-serif}
    .app{display:flex;height:100vh}
    .sidebar {width: 28%; padding: 16px; background: var(--panel); box-sizing: border-box; overflow-y: auto; scrollbar-width: none;}
    .sidebar::-webkit-scrollbar {display: none;}
    h1{margin:0 0 10px 0;color:var(--gold);font-size:16px}
    h2{margin:0 0 10px 0;color:var(--gold);font-size:12px}
    label{display:block;font-size:13px;color:#ddd;margin:10px 0 6px}
    select{width:100%;padding:8px;border-radius:6px;background:#2b2b2b;border:1px solid #333;color:#fff}
    button{margin-top:12px;padding:6px 12px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border:1px solid #2a2a2a;font-size:12px}
    th{background:#2a2a2a;color:var(--gold);text-align:left}
    .crime-row{cursor:default}
    .crime-row.muted{opacity:0.35; pointer-events: none;}
    .person-row{cursor:pointer}
    .person-row.muted{opacity:0.45}
    .person-row.selected{background: linear-gradient(90deg, rgba(255,204,0,0.15), rgba(255,204,0,0.05)); color: #000; font-weight:600;}
    #personnelTable td, #personnelTable th{font-size:11px;}
    #crimeTable td, #personnelTable th{font-size:11px;}
    .main{flex:1;display:flex;flex-direction:column;padding:10px;box-sizing:border-box}
    #map{flex:1;border-radius:6px;overflow:hidden;position:relative}
    #loadingOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center; background: rgba(0,0,0,0.6); z-index:9999;pointer-events:none;opacity:0;transition:opacity .28s;}
    #loadingOverlay.active{pointer-events:all;opacity:1}
    .spinner{width:48px;height:48px;border-radius:50%;border:6px solid #222;border-top-color:var(--gold);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #summaryBox{ position:absolute; bottom:12px; left:12px; background:black; color:yellow; padding:6px; border-radius:4px; font-size:11px; font-weight:500; z-index:500; max-width:360px; max-height:260px; overflow:auto; opacity:0.95;}
    #summaryBox table{border-collapse:collapse;}
    #summaryBox td{padding:2px 6px; border:1px solid #555; font-size:11px;}
    .leaflet-popup-content img {max-width:160px; max-height:160px; border-radius:6px; margin-top:6px; display:block !important; visibility:visible !important; opacity:1 !important;}
    .table-container { max-height: 110px; overflow-y: hidden; border: 1px solid #333; border-radius: 4px; transition: max-height 0.3s ease; }
    .table-container.expanded { max-height: 380px; overflow-y: auto; scrollbar-width: thin; }
    .table-container.expanded::-webkit-scrollbar { width: 6px; }
    .table-container.expanded::-webkit-scrollbar-track { background: #2a2a2a; }
    .table-container.expanded::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    .toggle-link { color: var(--accent); font-size: 12px; cursor: pointer; margin-top: 4px; display: inline-block; }
    a.viber-link { color: var(--accent); text-decoration: none; font-weight:600; margin-right:8px; }

    /* SHIFT LABEL ON MAP */
    #shiftLabel {
      position: absolute;
      top: 12px; right: 12px;
      background: rgba(0,0,0,0.75);
      color: #ffcc00;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      z-index: 600;
      pointer-events: none;
    }

    /* POPUP: force block layout + wrapping for clearer lines */
    .leaflet-popup-content { white-space: normal !important; word-break: break-word !important; }
    .leaflet-popup-content-wrapper { max-width: 400px !important; }
    .popup-personnel { font-size:13px; line-height:1.35; }
    .popup-row { margin:4px 0; }
    .popup-person { display:block; margin:6px 0; padding-bottom:4px; border-bottom:1px dashed rgba(0,0,0,0.12); }
    .popup-person .person-name { display:block; font-weight:600; margin-bottom:2px; }
    .popup-person .person-contact { display:block; margin-top:2px; }
    .popup-person .person-contact a.viber-link { color: #00bfff; font-weight:700; text-decoration:none; margin-right:6px; }
    .popup-person .person-contact a.call-link { margin-left:8px; text-decoration:none; }
    .popup-photo { margin-top:8px; }
    .popup-photo img { display:block !important; max-width:160px !important; max-height:160px !important; border-radius:6px; visibility:visible !important; opacity:1 !important; }
    .popup-photo.loading::before {
      content: 'Loading image...';
      display: block;
      text-align: center;
      color: #fff;
      font-size: 12px;
      margin-bottom: 4px;
    }

    /* Stylish popup card */
    .leaflet-popup-content-wrapper.custom-popup {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 4px 18px rgba(0,0,0,0.5);
      color: #eee;
      font-family: Inter, Arial, sans-serif;
    }
    .leaflet-popup-content.custom-popup {
      margin: 0;
      padding: 0;
    }
    .popup-card {
      padding: 12px 14px;
      max-width: 380px;
    }
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-header h3 {
      margin: 0;
      font-size: 15px;
      color: #000000;
      background: rgba(255,204,0,0.15);
    }
    .popup-callsign {
      font-size: 12px;
      background: rgba(255,204,0,0.15);
      padding: 2px 6px;
      border-radius: 6px;
    }
    .popup-row {
      font-size: 13px;
      margin: 4px 0;
    }
    .popup-people {
      margin-top: 6px;
    }
    .popup-person {
      margin: 6px 0;
      padding: 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }
    .popup-person .person-name {
      font-weight: 600;
      color: #9C2007;
    }
    .popup-photo {
      margin-top: 10px;
      text-align: center;
    }
    .popup-photo img {
      max-width: 100% !important;
      max-height: 160px !important;
      display: block !important;
      border-radius: 8px;
      border: 1px solid #333;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR: Filters, Personnel, Crimes -->
    <div class="sidebar">
      <h1>NIDS 2.0 &nbsp;&nbsp;<button id="refreshBtn">Refresh</button></h1>
      <!-- Station / Shift / Type filters (chained) -->
      <label for="stationFilter">Station</label>
      <select id="stationFilter"><option value="All">All</option></select>
      <label for="shiftFilter">Shift</label>
      <select id="shiftFilter"><option value="Auto">Auto (current)</option></select>
      <label for="typeFilter">Deployment Type</label>
      <select id="typeFilter" disabled><option value="All">All</option></select>
      <!-- Personnel -->
      <h2 style="margin-top:16px">Personnel</h2>
      <div id="personnelContainer" class="table-container">
        <table id="personnelTable">
          <thead><tr><th>Name</th><th>Mobile</th><th>CallSign</th><th>Station</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <span id="togglePersonnel" class="toggle-link" style="display:none;">Show more</span>
      <!-- Focus crimes -->
      <h2 style="margin-top:20px">8 Focus Crimes</h2>
      <table id="crimeTable"><thead><tr><th>Crime</th><th>Barangay</th><th><center>Count</center></th></tr></thead><tbody></tbody></table>
    </div>
    <!-- MAIN: Map + Summary + Shift Label -->
    <div class="main">
      <div id="map">
        <div id="summaryBox">Summary...</div>
        <div id="shiftLabel">Loading...</div>
      </div>
    </div>
  </div>
  <!-- Loading overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>
<script>
/* ===========================
   CONFIG / CONSTANTS
   ===========================
*/
const DEPLOYMENT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSGa3PhKZX1g8fbp48sNvJ4YkWhgLiYlW7Js5crfD_LWVgAW-PWQW6ctXgSuVu9xk7G9qKlUzS2Gyi/pub?output=csv";
const CRIME_SHEET_CSV = "https://docs.google.com/spreadsheets/d/1ToFBmKsJ9uJDlbvKz1ImMfzrY2H1kIEMQpefxOolG9U/gviz/tq?tqx=out:csv&gid=0";
/* … all your original constants … */

/* ---------- NEW: SHIFT LOGIC ---------- */
function getCurrentShift() {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const minutes = h * 60 + m;

  // 1st shift: 06:00 → 17:59  (360 → 1079 minutes)
  // 2nd shift: 18:00 → 05:59  (1080 → 359 minutes, wraps midnight)
  if (minutes >= 360 && minutes <= 1079) return "1st Shift";
  else return "2nd Shift";
}

/* Update the shift filter UI to reflect the current shift */
function setCurrentShiftFilter() {
  const cur = getCurrentShift();
  // Make sure the option exists (it will after the first load)
  const opt = [...shiftSelect.options].find(o => normalize(o.value) === normalize(cur));
  if (opt) {
    shiftSelect.value = opt.value;
    shiftSelect.disabled = true;               // user can still change it manually
    shiftSelect.title = `Current shift: ${cur}`;
    // bold the selected option
    for (const o of shiftSelect.options) o.style.fontWeight = (o.value === opt.value) ? "bold" : "normal";
  }
  selectedShift = cur;                         // force the filter variable
}

/* ===========================
   LOAD & NORMALIZE DATA
   ===========================
*/
async function loadData(){
  showLoading(true);
  try{
    const [depRows, crimeRows] = await Promise.all([ fetchCsv(DEPLOYMENT_SHEET_CSV), fetchCsv(CRIME_SHEET_CSV) ]);
    /* … all your original parsing … */
    allData = depRows.map((r, idx) => { /* unchanged */ });
    crimeData = crimeRows.map(r => { /* unchanged */ });

    /* ---------- AFTER DATA IS READY ---------- */
    refreshUI();                // builds station/shift/type dropdowns
    setCurrentShiftFilter();    // **auto-select current shift**
    applyFilters();             // now only current-shift markers are drawn
  } catch(err){
    console.error("[LOAD] Error:", err);
  } finally {
    showLoading(false);
  }
}

/* ===========================
   REFRESH UI
   ===========================
*/
function refreshUI(){
  /* … original code that builds station dropdown … */

  // ---- SHIFT DROPDOWN (now includes *all* shifts that exist in the sheet) ----
  const allShifts = [...new Set(allData.map(d => d.Shift).filter(Boolean))].sort();
  shiftSelect.innerHTML = "<option value='All'>All</option>" +
    allShifts.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

  // (type dropdown unchanged)
  /* … rest of your original refreshUI … */
}

/* ===========================
   APPLY FILTERS
   ===========================
*/
function applyFilters(){
  showLoading(true);
  const filtered = allData.filter(d =>
    (selectedStation === "All" || normalize(d.Station) === normalize(selectedStation)) &&
    (selectedShift   === "All" || normalize(d.Shift)   === normalize(selectedShift)) &&   // <-- respects auto-shift
    (selectedType    === "All" || normalize(d["Deployment Type"]) === normalize(selectedType))
  );

  /* … original marker removal & creation … */

  // ---- POPUP (shift line is still shown, but only current shift exists) ----
  if (r.Shift) {
    const row = document.createElement('div');
    row.className = 'popup-row';
    row.innerHTML = `<b>Shift:</b> ${escapeHtml(r.Shift)}`;   // only current shift appears
    popupDiv.appendChild(row);
  }

  /* … rest of marker creation, tables, summary … */
  showLoading(false);
}

/* ===========================
   FILTER EVENT HANDLERS
   ===========================
*/
stationSelect.onchange = function(){
  selectedStation = stationSelect.value;
  selectedShift = "All"; selectedType = "All";

  if(selectedStation === "All"){
    shiftSelect.innerHTML = "<option value='All'>All</option>"; shiftSelect.disabled = true;
    typeSelect.innerHTML  = "<option value='All'>All</option>";  typeSelect.disabled  = true;
  } else {
    const stationRows = allData.filter(d => normalize(d.Station) === normalize(selectedStation));
    const shifts = [...new Set(stationRows.map(r => r.Shift || "Unspecified"))];
    const types  = [...new Set(stationRows.map(r => r["Deployment Type"] || "Unspecified"))];
    shiftSelect.innerHTML = "<option value='All'>All</option>" + shifts.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    typeSelect.innerHTML  = "<option value='All'>All</option>" + types.map(t =>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    shiftSelect.disabled = false; typeSelect.disabled = false;
  }
  // **Re-apply the current-shift auto-filter when a new station is chosen**
  setCurrentShiftFilter();
  applyFilters();
};

/* Shift & Type handlers stay the same (they allow manual override) */
shiftSelect.onchange = function(){
  selectedShift = shiftSelect.value;
  // remove bold from previous selection
  for (const o of shiftSelect.options) o.style.fontWeight = "normal";
  shiftSelect.selectedOptions[0].style.fontWeight = "bold";
  applyFilters();
};
typeSelect.onchange = function(){
  selectedType = typeSelect.value;
  applyFilters();
};

/* Refresh button – also re-applies current shift */
refreshBtn.onclick = function(){
  selectedStation="All"; selectedShift="All"; selectedType="All";
  stationSelect.value="All"; shiftSelect.value="All"; typeSelect.value="All";
  map.setView(defaultCenter, defaultZoom);
  loadData();               // will auto-set current shift again
};

/* ===========================
   INITIAL LOAD
   ===========================
*/
loadData();

/* Auto-refresh every 10 min (keeps current shift up-to-date) */
setInterval(() => { console.log("[AUTO REFRESH]"); loadData(); }, 600000);
</script>
</body>
</html>
