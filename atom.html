<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NIDS v2.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#121212; --panel:#1f1f1f; --muted:#777; --accent:#00bfff; --gold:#ffcc00; --card:#222;}
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:Inter,Arial,Helvetica,sans-serif}
    .app{display:flex;height:100vh}
    .sidebar {width: 28%; padding: 16px; background: var(--panel); box-sizing: border-box; overflow-y: auto; scrollbar-width: none;}
    .sidebar::-webkit-scrollbar {display: none;}
    h1{margin:0 0 10px 0;color:var(--gold);font-size:16px}
    h2{margin:0 0 10px 0;color:var(--gold);font-size:12px}
    label{display:block;font-size:13px;color:#ddd;margin:10px 0 6px}
    select{width:100%;padding:8px;border-radius:6px;background:#2b2b2b;border:1px solid #333;color:#fff}
    button{margin-top:12px;padding:6px 12px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border:1px solid #2a2a2a;font-size:12px}
    th{background:#2a2a2a;color:var(--gold);text-align:left}
    .crime-row{cursor:default}
    .person-row{cursor:pointer}
    .person-row.selected{background: linear-gradient(90deg, rgba(255,204,0,0.15), rgba(255,204,0,0.05)); color: #000; font-weight:600;}
    .main{flex:1;display:flex;flex-direction:column;padding:10px;box-sizing:border-box}
    #map{flex:1;border-radius:6px;overflow:hidden;position:relative}
    #loadingOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center; background: rgba(0,0,0,0.6); z-index:9999;pointer-events:none;opacity:0;transition:opacity .28s;}
    #loadingOverlay.active{pointer-events:all;opacity:1}
    .spinner{width:48px;height:48px;border-radius:50%;border:6px solid #222;border-top-color:var(--gold);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #summaryBox{ position:absolute; bottom:12px; left:12px; background:black; color:yellow; padding:6px; border-radius:4px; font-size:11px; font-weight:500; z-index:500; max-width:360px; max-height:260px; overflow:auto; opacity:0.95;}
    #summaryBox table{border-collapse:collapse;}
    #summaryBox td{padding:2px 6px; border:1px solid #555; font-size:11px;}
    .table-container { max-height: 110px; overflow-y: hidden; border: 1px solid #333; border-radius: 4px; transition: max-height 0.3s ease; }
    .table-container.expanded { max-height: 380px; overflow-y: auto; scrollbar-width: thin; }
    .toggle-link { color: var(--accent); font-size: 12px; cursor: pointer; margin-top: 4px; display: inline-block; }
    a.viber-link { color: var(--accent); text-decoration: none; font-weight:600; margin-right:8px; }

    /* LOGIN MODAL */
    #loginModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #121212 0%, #1a1a2e 50%, #16213e 100%);
      z-index: 10000; display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .login-box {
      background: #1f1f1f; padding: 24px; border-radius: 12px; width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      border: 1px solid #333; animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .login-box h2 { margin: 0 0 16px; color: var(--gold); text-align: center; }
    .login-box input { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #444; background: #2b2b2b; color: #fff; }
    .login-box button { width: 100%; margin-top: 16px; }
    #rememberMe { margin: 8px 0; display: flex; align-items: center; font-size: 12px; color: #ddd; }
    #rememberMe input { width: auto; margin-right: 8px; }

    /* LOGOUT */
    #logoutBtn { background: #ff4444; float: right; padding: 4px 8px; font-size: 11px; margin-left: 8px; }

    /* EXPORT */
    .export-btns { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    .export-btns button { flex: 1; min-width: 100px; font-size: 11px; padding: 6px 8px; }
  </style>
</head>
<body>

<!-- LOGIN MODAL -->
<div id="loginModal">
  <div class="login-box">
    <h2>NIDS Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <label id="rememberMe">
      <input type="checkbox" id="rememberMeChk" /> Remember Me (7 days)
    </label>
    <button id="loginBtn">Login</button>
    <div style="margin-top:10px; font-size:11px; color:#aaa;">
      <b>Demo Accounts:</b><br>
      Admin: <code>admin / admin123</code><br>
      Sibulan: <code>sibulan / sibulan123</code>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <div class="sidebar">
    <h1>NIDS 2.0 <span id="userInfo" style="font-size:12px; color:#aaa;"></span>
      <button id="refreshBtn">Refresh</button>
      <button id="logoutBtn">Logout</button>
    </h1>

    <!-- Admin Controls -->
    <div id="adminControls" style="display:none;">
      <label for="stationFilter">Station</label>
      <select id="stationFilter"><option value="All">All</option></select>
      <label for="shiftFilter">Shift</label>
      <select id="shiftFilter"><option value="All">All</option></select>
      <label for="typeFilter">Deployment Type</label>
      <select id="typeFilter"><option value="All">All</option></select>
    </div>

    <!-- Station-Only View -->
    <div id="stationOnly" style="display:none; margin:16px 0; padding:10px; background:#2a2a2a; border-radius:6px; text-align:center;">
      <strong id="lockedStation"></strong><br>
      <small style="color:#aaa;">Your station view</small>
    </div>

    <!-- Personnel -->
    <h2 style="margin-top:16px">Personnel</h2>
    <div id="personnelContainer" class="table-container">
      <table id="personnelTable">
        <thead><tr><th>Name</th><th>Mobile</th><th>CallSign</th><th>Station</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <span id="togglePersonnel" class="toggle-link" style="display:none;">Show more</span>

    <!-- 8 Focus Crimes -->
    <h2 style="margin-top:20px">8 Focus Crimes</h2>
    <table id="crimeTable"><thead><tr><th>Crime</th><th>Barangay</th><th><center>Count</center></th></tr></thead><tbody></tbody></table>

    <!-- Export Buttons -->
    <div id="exportButtons" class="export-btns" style="display:none;">
      <button onclick="exportToExcel()">Export Excel</button>
      <button onclick="exportToPDF()">Export PDF</button>
    </div>
  </div>

  <div class="main">
    <div id="map">
      <div id="summaryBox">Loading...</div>
    </div>
  </div>
</div>

<div id="loadingOverlay"><div class="spinner"></div></div>

<script>
/* ===========================
   BACKEND CONFIG
   =========================== */
const BACKEND_URL = 'https://script.google.com/macros/s/YOUR_GAS_ID/exec'; // REPLACE WITH YOUR GAS URL

/* ===========================
   AUTH STATE
   =========================== */
let currentUser = null;
let authToken = null;

/* ===========================
   LOGIN FUNCTION
   =========================== */
async function login() {
  const username = document.getElementById('username').value.trim().toLowerCase();
  const password = document.getElementById('password').value;
  const rememberMe = document.getElementById('rememberMeChk').checked;

  if (!username || !password) {
    alert('Enter username and password');
    return;
  }

  showLoading(true);
  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, rememberMe })
    });
    const data = await res.json();

    if (data.success) {
      currentUser = data.user;
      authToken = data.token;
      if (rememberMe && data.expires) {
        localStorage.setItem('nids_auth', JSON.stringify({ token: data.token, expires: data.expires, user: data.user }));
      }
      document.getElementById('loginModal').remove();
      document.querySelector('.app').style.display = 'flex';
      document.getElementById('userInfo').textContent = `${currentUser.station || 'Admin'} (${currentUser.role})`;
      document.getElementById('logoutBtn').onclick = logout;
      initApp();
    } else {
      alert(data.error || 'Login failed');
    }
  } catch (err) {
    alert('Server error: ' + err.message);
  } finally {
    showLoading(false);
  }
}

/* ===========================
   LOGOUT
   =========================== */
function logout() {
  localStorage.removeItem('nids_auth');
  currentUser = null;
  authToken = null;
  document.querySelector('.app').style.display = 'none';
  location.reload(); // Simple reload to show login again
}

/* ===========================
   CHECK REMEMBER ME ON LOAD
   =========================== */
window.addEventListener('load', () => {
  const saved = localStorage.getItem('nids_auth');
  if (saved) {
    try {
      const { token, expires, user } = JSON.parse(saved);
      if (Date.now() < expires) {
        currentUser = user;
        authToken = token;
        document.querySelector('.app').style.display = 'flex';
        document.getElementById('userInfo').textContent = `${currentUser.station || 'Admin'} (${currentUser.role})`;
        document.getElementById('logoutBtn').onclick = logout;
        initApp();
        return;
      }
    } catch (e) {
      localStorage.removeItem('nids_auth');
    }
  }

  // CRITICAL: Set login handler AFTER load check
  document.getElementById('loginBtn').onclick = login;
});

/* ===========================
   REST OF APP (initApp, loadData, etc.)
   =========================== */
function showLoading(on) {
  document.getElementById('loadingOverlay').classList.toggle('active', on);
}

function initApp() {
  if (currentUser.role === 'admin') {
    document.getElementById('adminControls').style.display = 'block';
    document.getElementById('exportButtons').style.display = 'flex';
  } else {
    document.getElementById('stationOnly').style.display = 'block';
    document.getElementById('lockedStation').textContent = currentUser.station;
  }
  loadData(); // Your full loadData() goes here
}

function loadData() {
  showLoading(true);
  // Your full CSV fetch + parsing + map code here
  setTimeout(() => {
    showLoading(false);
    document.getElementById('summaryBox').innerHTML = 'Data loaded!';
  }, 1000);
}
</script>
</body>
</html>
