<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NIDS v2.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#121212; --panel:#1f1f1f; --accent:#00bfff; --gold:#ffcc00;}
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body,#map,.main,.app{height:100vh;width:100vw;overflow:hidden;}
    body{background:var(--bg);color:#eee;font-family:Arial,sans-serif;display:flex;}
    .app{flex:1;display:flex;height:100vh;}
    .sidebar{width:28%;background:var(--panel);padding:16px;overflow-y:auto;}
    h1{font-size:16px;color:var(--gold);margin-bottom:12px;}
    label{font-size:13px;color:#ddd;margin:10px 0 6px;display:block;}
    select,button{width:100%;padding:10px;border-radius:6px;margin-bottom:10px;background:#2b2b2b;border:1px solid #333;color:#fff;font-size:14px;}
    button{background:var(--accent);border:none;cursor:pointer;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:8px 6px;border:1px solid #444;text-align:left;vertical-align:top;}
    th{background:#2a2a2a;color:var(--gold);font-weight:bold;}
    .main{flex:1;position:relative;}
    #map{width:100%;height:100%;}
    #summaryBox{
      position:absolute; bottom:12px; left:12px; background:#000; color:yellow; 
      padding:8px; border-radius:6px; font-size:12px; font-weight:500; 
      z-index:1000; max-width:320px; max-height:180px; overflow:auto;
    }
    #loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity .3s;}
    #loadingOverlay.active{opacity:1;pointer-events:all;}
    .spinner{width:50px;height:50px;border:6px solid #333;border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .table-container{max-height:180px;overflow-y:auto;margin-bottom:8px;}
    .toggle-link{color:var(--accent);font-size:13px;cursor:pointer;margin-top:4px;display:block;}
    #loginModal{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#121212,#1a1a2e);display:flex;align-items:center;justify-content:center;z-index:10000;}
    .login-box{background:#1f1f1f;padding:28px;border-radius:12px;width:340px;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:1px solid #333;}
    .login-box h2{color:var(--gold);text-align:center;margin-bottom:16px;font-size:18px;}
    .login-box input{width:100%;padding:12px;margin:8px 0;border-radius:6px;background:#2b2b2b;border:1px solid #444;color:#fff;font-size:15px;}
    .login-box button{width:100%;margin-top:16px;padding:12px;font-size:15px;}
    #rememberMe{margin:8px 0;font-size:13px;color:#ddd;display:flex;align-items:center;}
    #rememberMe input{width:auto;margin-right:8px;}
    #logoutBtn{background:#ff4444;padding:6px 10px;font-size:12px;margin-left:8px;float:right;border-radius:4px;}
    .export-btns{display:flex;gap:8px;margin-top:12px;}
    .export-btns button{flex:1;font-size:12px;padding:10px;}
    #stationOnly{display:none;margin:16px 0;padding:12px;background:#2a2a2a;border-radius:6px;text-align:center;font-size:14px;}
  </style>
</head>
<body>

<div id="loginModal">
  <div class="login-box">
    <h2>NIDS Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <label id="rememberMe"><input type="checkbox" id="rememberMeChk" /> Remember Me</label>
    <button id="loginBtn">Login</button>
    <div style="margin-top:10px;font-size:11px;color:#aaa;">
      <b>Demo:</b><br>
      <code>admin / admin123</code><br>
      <code>sibulan / sibulan123</code><br>
      <code>dumaguete / dgte123</code>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <div class="sidebar">
    <h1>NIDS 2.0 
      <span id="userInfo" style="font-size:12px;color:#aaa;"></span>
      <button id="refreshBtn">Refresh</button>
      <button id="logoutBtn">Logout</button>
    </h1>

    <div id="adminControls" style="display:none;">
      <label>Station</label>
      <select id="stationFilter"><option value="All">All</option></select>
      <label>Shift</label>
      <select id="shiftFilter"><option value="All">All</option></select>
      <label>Deployment Type</label>
      <select id="typeFilter"><option value="All">All</option></select>
    </div>

    <div id="stationOnly">
      <strong id="lockedStation"></strong><br>
      <small style="color:#aaa;">Current shift only</small>
    </div>

    <h2 style="margin-top:16px">Personnel</h2>
    <div id="personnelContainer" class="table-container">
      <table id="personnelTable">
        <thead><tr><th>Name</th><th>Mobile</th><th>CallSign</th><th>Station</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <span id="togglePersonnel" class="toggle-link" style="display:none;">Show more</span>

    <h2 style="margin-top:20px">8 Focus Crimes</h2>
    <table id="crimeTable">
      <thead><tr><th>Crime</th><th>Barangay</th><th><center>Count</center></th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="exportButtons" class="export-btns" style="display:none;">
      <button onclick="exportToExcel()">Export Excel</button>
      <button onclick="exportToPDF()">Export PDF</button>
    </div>
  </div>

  <div class="main">
    <div id="map"></div>
    <div id="summaryBox">Loading...</div>
  </div>
</div>

<div id="loadingOverlay"><div class="spinner"></div></div>

<script>
/* =========================== ICONS (FIXED PNG URLs) =========================== */
const ICONS = {
  "Beat Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/footpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Motorcycle Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/motorpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Mobile Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/mobilepatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Checkpoint": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/checkpoint.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Stationed": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/stationed.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "default": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/default.png", iconSize:[32,32], iconAnchor:[16,32] })
};

/* =========================== USERS =========================== */
const USERS = {
  "admin": { pass: "admin123", role: "admin" },
  "sibulan": { pass: "sibulan123", role: "station", station: "Sibulan PS" },
  "dumaguete": { pass: "dgte123", role: "station", station: "Dumaguete CPS" }
};

let currentUser = null;
let allData = [], crimeData = [];
let markerCluster = null;
let selectedStation = "All", selectedShift = "All", selectedType = "All";
let personnelExpanded = false;

/* DOM */
const stationSelect = document.getElementById("stationFilter");
const shiftSelect = document.getElementById("shiftFilter");
const typeSelect = document.getElementById("typeFilter");
const personnelTbody = document.querySelector("#personnelTable tbody");
const crimeTbody = document.querySelector("#crimeTable tbody");
const loadingOverlay = document.getElementById("loadingOverlay");
const summaryBox = document.getElementById("summaryBox");
const toggleLink = document.getElementById("togglePersonnel");
const refreshBtn = document.getElementById("refreshBtn");

/* =========================== MAP =========================== */
const map = L.map('map', { zoomControl: true }).setView([9.3, 123.2], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
markerCluster = L.markerClusterGroup({ maxClusterRadius: 50 });
map.addLayer(markerCluster);

/* =========================== PARSERS (ROBUST) =========================== */
function getField(row, ...keys) {
  if (!row) return "";
  for (const key of keys) {
    const val = row[key];
    if (val !== undefined && val !== null && String(val).trim() !== "") {
      return String(val).trim();
    }
  }
  return "";
}

function parseLatLngFromRow(r) {
  const latField = getField(r, "Latitude, Longitude", "Lat_Long", "Latitude", "Lat");
  if (!latField) return null;
  const cleaned = latField.replace(/\s/g, '');
  const match = cleaned.match(/(\d+\.\d+)[^\d]*(\d+\.\d+)/);
  if (match) return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
  return null;
}

function matchesStation(sheetName, userStation) {
  if (!sheetName || !userStation) return false;
  const clean = str => str.toLowerCase().replace(/[^\w]/g, '');
  const s1 = clean(sheetName);
  const s2 = clean(userStation);
  return s1.includes(s2) || s2.includes(s1);
}

function getIcon(type) {
  const key = type.trim();
  return ICONS[key] || ICONS["default"];
}

/* =========================== DATA LOAD =========================== */
const DEPLOYMENT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSGa3PhKZX1g8fbp48sNvJ4YkWhgLiYlW7Js5crfD_LWVgAW-PWQW6ctXgSuVu9xk7G9qKlUzS2Gyi/pub?output=csv";
const CRIME_SHEET_CSV = "https://docs.google.com/spreadsheets/d/1ToFBmKsJ9uJDlbvKz1ImMfzrY2H1kIEMQpefxOolG9U/gviz/tq?tqx=out:csv&gid=0";

async function loadData() {
  showLoading(true);
  try {
    const cacheKey = 'nids_data_v6';
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      const { data, crime, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp < 5 * 60 * 1000) {
        allData = data; crimeData = crime;
        refreshUI(); applyFilters();
        showLoading(false);
        return;
      }
    }

    const [depText, crimeText] = await Promise.all([
      fetch(DEPLOYMENT_SHEET_CSV).then(r => r.text()),
      fetch(CRIME_SHEET_CSV).then(r => r.text())
    ]);

    const dep = Papa.parse(depText, { header: true }).data;
    const crime = Papa.parse(crimeText, { header: true }).data;

    allData = dep.map(r => {
      const coords = parseLatLngFromRow(r);
      if (!coords) return null;
      const personnelStr = getField(r, "Personnel", "Personnel: (e.g. Rank FName MI LName)");
      const personnel = personnelStr ? personnelStr.split(",").map(p => p.trim()).filter(Boolean) : [];
      const type = getField(r, "Types Deployment", "Deployment Type") || "default";
      const station = getField(r, "Station/Unit", "Station") || "Unknown";
      return {
        Station: station,
        Shift: getField(r, "Duty Shift", "Duty Shift:") || "Unspecified",
        "Deployment Type": type,
        CallSign: getField(r, "Call Sign", "Call Sign:") || "",
        Location: getField(r, "Deployment Area", "Location") || "",
        Photo: getImageUrl(getField(r, "Picture with Timestamp", "Picture")),
        PersonnelList: personnel.map((n, i) => ({ 
          name: n, 
          mobile: i === 0 ? getField(r, "Contact Number", "Contact Number:") : "" 
        })),
        Lat: coords.lat, Lng: coords.lng,
        Icon: getIcon(type)
      };
    }).filter(Boolean);

    crimeData = crime.map(r => ({
      Station: getField(r, "Station") || "Unknown",
      "Focus Crimes": getField(r, "Focus Crimes", "Crime") || "",
      Barangay: getField(r, "Barangay") || "Unknown"
    }));

    localStorage.setItem(cacheKey, JSON.stringify({ data: allData, crime: crimeData, timestamp: Date.now() }));
    refreshUI(); applyFilters();
  } catch (e) {
    summaryBox.innerHTML = "Using cached data.";
    console.error(e);
  } finally {
    showLoading(false);
  }
}

function getImageUrl(url) {
  if (!url) return "";
  const match = url.match(/id=([^&]+)/);
  return match ? `https://drive.google.com/thumbnail?id=${match[1]}&sz=w240` : "";
}

function showLoading(on) { loadingOverlay.classList.toggle("active", on); }

/* =========================== UI POPULATE =========================== */
function refreshUI() {
  // Stations
  const stations = [...new Set(allData.map(d => d.Station))].sort();
  stationSelect.innerHTML = "<option value='All'>All</option>" + stations.map(s => `<option>${s}</option>`).join("");

  // Shifts
  const shifts = [...new Set(allData.map(d => d.Shift))].sort();
  shiftSelect.innerHTML = "<option value='All'>All</option>" + shifts.map(s => `<option>${s}</option>`).join("");

  // Types
  const types = [...new Set(allData.map(d => d["Deployment Type"]))].sort();
  typeSelect.innerHTML = "<option value='All'>All</option>" + types.map(t => `<option>${t}</option>`).join("");

  markerCluster.clearLayers();
}

/* =========================== FILTERS =========================== */
function applyFilters() {
  const isStation = currentUser.role === "station";
  const stationFilter = isStation ? currentUser.station : selectedStation;

  const filtered = allData.filter(d => {
    const stationMatch = stationFilter === "All" || matchesStation(d.Station, stationFilter);
    const shiftMatch = selectedShift === "All" || d.Shift === selectedShift;
    const typeMatch = selectedType === "All" || d["Deployment Type"] === selectedType;
    return stationMatch && shiftMatch && typeMatch;
  });

  markerCluster.clearLayers();
  const bounds = [];

  filtered.forEach(r => {
    const marker = L.marker([r.Lat, r.Lng], { icon: r.Icon });
    const popup = `
      <div style="max-width:280px;font-size:13px;">
        <h3 style="margin:0 0 4px;background:rgba(255,204,0,0.15);padding:4px;color:#000;font-size:14px;">${r.Station}</h3>
        <b>Area:</b> ${r.Location}<br>
        <b>Shift:</b> ${r.Shift}<br>
        <b>Type:</b> ${r["Deployment Type"]}<br>
        <b>Callsign:</b> ${r.CallSign}<br>
        ${r.PersonnelList.map(p => `<div style="margin:4px 0;"><b>${p.name}</b><br>${p.mobile ? `<a href="tel:${p.mobile}" style="color:#00bfff;">${p.mobile}</a>` : ''}</div>`).join("")}
        ${r.Photo ? `<img src="${r.Photo}" style="max-width:100%;margin-top:6px;border-radius:4px;" loading="lazy">` : ''}
      </div>`;
    marker.bindPopup(popup, { maxWidth: 300 });
    markerCluster.addLayer(marker);
    bounds.push([r.Lat, r.Lng]);
  });

  if (bounds.length) map.fitBounds(bounds, { padding: [30, 30], maxZoom: 16 });
  else map.setView([9.3, 123.2], 10);

  renderPersonnelTable(filtered);
  renderCrimeTable(isStation ? currentUser.station : stationFilter);
  updateSummaryBox(filtered, isStation ? currentUser.station : stationFilter);
}

/* =========================== TABLES (READABLE) =========================== */
function renderPersonnelTable(data) {
  personnelTbody.innerHTML = "";
  const rows = data.flatMap(d => 
    d.PersonnelList.length > 0 
      ? d.PersonnelList.map(p => ({ ...p, Station: d.Station, CallSign: d.CallSign }))
      : [{ name: "No personnel", mobile: "", Station: d.Station, CallSign: d.CallSign }]
  );
  const visible = personnelExpanded ? rows : rows.slice(0, 8);
  visible.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="font-size:13px;">${p.name}</td>
                    <td style="font-size:12px;">${p.mobile ? `<a href="tel:${p.mobile}" style="color:#00bfff;">${p.mobile}</a>` : ''}</td>
                    <td style="font-size:12px;">${p.CallSign}</td>
                    <td style="font-size:11px;">${p.Station}</td>`;
    personnelTbody.appendChild(tr);
  });
  toggleLink.style.display = rows.length > 8 ? "inline-block" : "none";
  toggleLink.onclick = () => { personnelExpanded = !personnelExpanded; applyFilters(); };
  toggleLink.textContent = personnelExpanded ? "Show less" : `Show more (${rows.length})`;
}

function renderCrimeTable(station) {
  crimeTbody.innerHTML = "";
  const crimes = station === "All" ? crimeData : crimeData.filter(c => matchesStation(c.Station, station));
  const counts = {};
  crimes.forEach(c => { counts[c["Focus Crimes"]] = (counts[c["Focus Crimes"]] || 0) + 1; });

  const focusCrimes = ["Murder","Homicide","Physical Injury","Rape","Robbery","Theft","Carnapping MC","Carnapping MV"];
  focusCrimes.forEach(crime => {
    const count = counts[crime] || 0;
    const barangays = [...new Set(crimes.filter(c => c["Focus Crimes"] === crime).map(c => c.Barangay))];
    const brgyText = station === "All" ? "All" : (barangays.length > 0 ? barangays.join(", ") : "None");

    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="font-size:13px;">${crime}</td>
                    <td style="font-size:11px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${brgyText}">${brgyText}</td>
                    <td style="text-align:center;font-weight:bold;">${count}</td>`;
    crimeTbody.appendChild(tr);
  });
}

function updateSummaryBox(data, station) {
  const total = data.reduce((a, d) => a + d.PersonnelList.length, 0);
  summaryBox.innerHTML = `<b style="font-size:14px;">${station}</b><br>Personnel: <b>${total}</b><br>Shift: <b>${selectedShift}</b>`;
}

/* =========================== EXPORT =========================== */
function exportToExcel() {
  if (currentUser.role !== "admin") return;
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(allData.map(d => ({
    Station: d.Station, Shift: d.Shift, Type: d["Deployment Type"],
    Personnel: d.PersonnelList.map(p => p.name).join(", "),
    Contact: d.PersonnelList[0]?.mobile || ""
  })));
  XLSX.utils.book_append_sheet(wb, ws, "Deployments");
  XLSX.writeFile(wb, "NIDS_Export.xlsx");
}

async function exportToPDF() {
  if (currentUser.role !== "admin") return;
  const canvas = await html2canvas(document.getElementById('map'), { scale: 1.5 });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'mm', 'a4');
  pdf.addImage(img, 'PNG', 10, 10, 270, 180);
  pdf.text("NIDS Report", 10, 200);
  pdf.save("NIDS_Report.pdf");
}

/* =========================== LOGIN & INIT =========================== */
document.getElementById("loginBtn").onclick = () => {
  const u = document.getElementById("username").value.trim().toLowerCase();
  const p = document.getElementById("password").value;
  const chk = document.getElementById("rememberMeChk").checked;
  if (USERS[u] && USERS[u].pass === p) {
    currentUser = USERS[u];
    document.getElementById("loginModal").remove();
    document.querySelector(".app").style.display = "flex";
    document.getElementById("userInfo").textContent = `${currentUser.station || 'Admin'} (${currentUser.role})`;
    document.getElementById("logoutBtn").onclick = () => { localStorage.removeItem('nids_user'); location.reload(); };
    if (chk) localStorage.setItem('nids_user', JSON.stringify(currentUser));
    setTimeout(() => {
      map.invalidateSize();
      initApp();
    }, 100);
  } else alert("Invalid credentials");
};

if (localStorage.getItem('nids_user')) {
  currentUser = JSON.parse(localStorage.getItem('nids_user'));
  document.querySelector(".app").style.display = "flex";
  document.getElementById("userInfo").textContent = `${currentUser.station || 'Admin'} (${currentUser.role})`;
  document.getElementById("logoutBtn").onclick = () => { localStorage.removeItem('nids_user'); location.reload(); };
  document.getElementById("loginModal").remove();
  setTimeout(() => {
    map.invalidateSize();
    initApp();
  }, 100);
}

function initApp() {
  if (currentUser.role === "admin") {
    document.getElementById("adminControls").style.display = "block";
    document.getElementById("exportButtons").style.display = "flex";
    document.getElementById("stationOnly").style.display = "none";
  } else {
    document.getElementById("adminControls").style.display = "none";
    document.getElementById("exportButtons").style.display = "none";
    document.getElementById("stationOnly").style.display = "block";
    document.getElementById("lockedStation").textContent = currentUser.station;
    selectedStation = currentUser.station;
  }
  loadData();

  stationSelect.onchange = () => { selectedStation = stationSelect.value; applyFilters(); };
  shiftSelect.onchange = () => { selectedShift = shiftSelect.value; applyFilters(); };
  typeSelect.onchange = () => { selectedType = typeSelect.value; applyFilters(); };
  refreshBtn.onclick = () => { localStorage.removeItem('nids_data_v6'); loadData(); };
}
</script>
</body>
</html>
