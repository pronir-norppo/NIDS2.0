<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NIDS v2.0</title>
  <!-- Leaflet & PapaParse -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="author" content="PSSg Leong, RAC - PIDMU, NOrPPO, PRO NIR" />
  <style>
    :root{--bg:#121212; --panel:#1f1f1f; --muted:#777; --accent:#00bfff; --gold:#ffcc00; --card:#222;}
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:Inter,Arial,Helvetica,sans-serif}
    .app{display:flex;height:100vh}
    .sidebar {width: 28%; padding: 16px; background: var(--panel); box-sizing: border-box; overflow-y: auto; scrollbar-width: none;}
    .sidebar::-webkit-scrollbar {display: none;}
    h1{margin:0 0 10px 0;color:var(--gold);font-size:16px}
    h2{margin:0 0 10px 0;color:var(--gold);font-size:12px}
    label{display:block;font-size:13px;color:#ddd;margin:10px 0 6px}
    select{width:100%;padding:8px;border-radius:6px;background:#2b2b2b;border:1px solid #333;color:#fff}
    button{margin-top:12px;padding:6px 12px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border:1px solid #2a2a2a;font-size:12px}
    th{background:#2a2a2a;color:var(--gold);text-align:left}
    .crime-row{cursor:default}
    .crime-row.muted{opacity:0.35; pointer-events: none;}
    .person-row{cursor:pointer}
    .person-row.muted{opacity:0.45}
    .person-row.selected{background: linear-gradient(90deg, rgba(255,204,0,0.15), rgba(255,204,0,0.05)); color: #000; font-weight:600;}
    #personnelTable td, #personnelTable th{font-size:11px;}
    #crimeTable td, #personnelTable th{font-size:11px;}
    .main{flex:1;display:flex;flex-direction:column;padding:10px;box-sizing:border-box}
    #map{flex:1;border-radius:6px;overflow:hidden;position:relative}
    #loadingOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center; background: rgba(0,0,0,0.6); z-index:9999;pointer-events:none;opacity:0;transition:opacity .28s;}
    #loadingOverlay.active{pointer-events:all;opacity:1}
    .spinner{width:48px;height:48px;border-radius:50%;border:6px solid #222;border-top-color:var(--gold);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #summaryBox{ position:absolute; bottom:12px; left:12px; background:black; color:yellow; padding:6px; border-radius:4px; font-size:11px; font-weight:500; z-index:500; max-width:360px; max-height:260px; overflow:auto; opacity:0.95;}
    #summaryBox table{border-collapse:collapse;}
    #summaryBox td{padding:2px 6px; border:1px solid #555; font-size:11px;}
    .leaflet-popup-content img {max-width:160px; max-height:160px; border-radius:6px; margin-top:6px; display:block !important; visibility:visible !important; opacity:1 !important;}
    .table-container { max-height: 110px; overflow-y: hidden; border: 1px solid #333; border-radius: 4px; transition: max-height 0.3s ease; }
    .table-container.expanded { max-height: 380px; overflow-y: auto; scrollbar-width: thin; }
    .table-container.expanded::-webkit-scrollbar { width: 6px; }
    .table-container.expanded::-webkit-scrollbar-track { background: #2a2a2a; }
    .table-container.expanded::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    .toggle-link { color: var(--accent); font-size: 12px; cursor: pointer; margin-top: 4px; display: inline-block; }
    a.viber-link { color: var(--accent); text-decoration: none; font-weight:600; margin-right:8px; }
   
    /* POPUP: force block layout + wrapping for clearer lines */
    .leaflet-popup-content { white-space: normal !important; word-break: break-word !important; }
    .leaflet-popup-content-wrapper { max-width: 400px !important; }
    .popup-personnel { font-size:13px; line-height:1.35; }
    .popup-row { margin:4px 0; }
    .popup-person { display:block; margin:6px 0; padding-bottom:4px; border-bottom:1px dashed rgba(0,0,0,0.12); }
    .popup-person .person-name { display:block; font-weight:600; margin-bottom:2px; }
    .popup-person .person-contact { display:block; margin-top:2px; }
    .popup-person .person-contact a.viber-link { color: #00bfff; font-weight:700; text-decoration:none; margin-right:6px; }
    .popup-person .person-contact a.call-link { margin-left:8px; text-decoration:none; }
    .popup-photo { margin-top:8px; }
    .popup-photo img { display:block !important; max-width:160px !important; max-height:160px !important; border-radius:6px; visibility:visible !important; opacity:1 !important; }
    .popup-photo.loading::before {
      content: 'Loading image...';
      display: block;
      text-align: center;
      color: #fff;
      font-size: 12px;
      margin-bottom: 4px;
    }
   
    /* Stylish popup card */
    .leaflet-popup-content-wrapper.custom-popup {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 0;
      box-shadow: 0 4px 18px rgba(0,0,0,0.5);
      color: #eee;
      font-family: Inter, Arial, sans-serif;
    }
    .leaflet-popup-content.custom-popup {
      margin: 0;
      padding: 0;
    }
    .popup-card {
      padding: 12px 14px;
      max-width: 380px;
    }
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-header h3 {
      margin: 0;
      font-size: 15px;
      color: #000000;
      background: rgba(255,204,0,0.15);
    }
    .popup-callsign {
      font-size: 12px;
      background: rgba(255,204,0,0.15);
      padding: 2px 6px;
      border-radius: 6px;
    }
    .popup-row {
      font-size: 13px;
      margin: 4px 0;
    }
    .popup-people {
      margin-top: 6px;
    }
    .popup-person {
      margin: 6px 0;
      padding: 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }
    .popup-person .person-name {
      font-weight: 600;
      color: #9C2007;
    }
    .popup-photo {
      margin-top: 10px;
      text-align: center;
    }
    .popup-photo img {
      max-width: 100% !important;
      max-height: 160px !important;
      display: block !important;
      border-radius: 8px;
      border: 1px solid #333;
      visibility: visible !important;
      opacity: 1 !important;
    }
    .leaflet-popup-content .popup-photo img {
      max-width: 160px !important;
      max-height: 160px !important;
      display: block !important;
      border-radius: 8px;
      border: 1px solid #333;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR: Filters, Personnel, Crimes -->
    <div class="sidebar">
      <h1>NIDS 2.0 &nbsp;&nbsp;<button id="refreshBtn">Refresh</button></h1>
      <!-- Station / Shift / Type filters (chained) -->
      <label for="stationFilter">Station</label>
      <select id="stationFilter"><option value="All">All</option></select>
      <label for="shiftFilter">Shift</label>
      <select id="shiftFilter" disabled><option value="All">All</option></select>
      <label for="typeFilter">Deployment Type</label>
      <select id="typeFilter" disabled><option value="All">All</option></select>
      <!-- Personnel -->
      <h2 style="margin-top:16px">Personnel</h2>
      <div id="personnelContainer" class="table-container">
        <table id="personnelTable">
          <thead><tr><th>Name</th><th>Mobile</th><th>CallSign</th><th>Station</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <span id="togglePersonnel" class="toggle-link" style="display:none;">Show more</span>
      <!-- Focus crimes -->
      <h2 style="margin-top:20px">8 Focus Crimes</h2>
      <table id="crimeTable"><thead><tr><th>Crime</th><th>Barangay</th><th><center>Count</center></th></tr></thead><tbody></tbody></table>
    </div>
    <!-- MAIN: Map + Summary -->
    <div class="main">
      <div id="map">
        <div id="summaryBox">Summary...</div>
      </div>
    </div>
  </div>
  <!-- Loading overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>
<script>
/* ===========================
   CONFIG / CONSTANTS
   ===========================
*/
const DEPLOYMENT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSGa3PhKZX1g8fbp48sNvJ4YkWhgLiYlW7Js5crfD_LWVgAW-PWQW6ctXgSuVu9xk7G9qKlUzS2Gyi/pub?output=csv";
const CRIME_SHEET_CSV = "https://docs.google.com/spreadsheets/d/1ToFBmKsJ9uJDlbvKz1ImMfzrY2H1kIEMQpefxOolG9U/gviz/tq?tqx=out:csv&gid=0";
const PLACEHOLDER_IMG = "https://via.placeholder.com/160x90.png";

function getImageUrl(rawUrl){
  if(!rawUrl) return PLACEHOLDER_IMG;
  let url = String(rawUrl).trim();
  try {
    if(url.includes("open?id=")){
      const id = new URL(url).searchParams.get("id");
      if(id) return `https://drive.google.com/thumbnail?id=${id}&sz=w420`;
    }
    if(url.includes("/file/d/")){
      const match = url.match(/\/file\/d\/([^/]+)\//);
      if(match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w420`;
    }
    if(url.startsWith("http")) return url;
  } catch(e){
    console.warn("[IMG PARSER] Failed:", rawUrl, e);
  }
  return PLACEHOLDER_IMG;
}
const FALLBACK_TEST_IMAGE = "https://via.placeholder.com/160x90.png";
const STATIC_TEST_IMAGE = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAD+SURBVFhH7ZZBCsJADEU7uA1BPYJ7sA+2F3EP7sHewb0o0klySBIyM7Mzs3P2T4L/5S8s2P3+MwAAbG9vby8AAOzq6urqAABsb29vLwAA7O7u7u4AAOzq6urqAABsb29vLwAA7O7u7u4AAOzq6urqAABsb29vLwAA7O7u7u4AAOzq6urqAABsb29vLwAA7O7u7u4AAOzq6urqAABsb29vLwAA7O7u7u4AAOzq6urqAABsb29vLwAA7O7u7u4AAADgfwMA2m4z3wAAAABJRU5ErkJggg==";
const FOCUS_CRIMES = ["Murder","Homicide","Physical Injury","Rape","Robbery","Theft","Carnapping MC","Carnapping MV"];
const defaultCenter = [9.3, 123.2];
const defaultZoom = 9;
const FALLBACK_COORDS = { lat: 9.3, lng: 123.2 };
const ICONS = {
  "Beat Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/footpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Motorcycle Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/motorpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Mobile Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/mobilepatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Checkpoint": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/checkpoint.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "Stationed": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/stationed.png", iconSize:[32,32], iconAnchor:[16,32] }),
  "default": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/default.png", iconSize:[32,32], iconAnchor:[16,32] })
};
const FALLBACK_ICON = L.icon({ iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", iconSize: [25, 41], iconAnchor: [12, 41] });

/* ---------- CURRENT SHIFT DETECTION ---------- */
function getCurrentShift() {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const minutes = h * 60 + m;
  if (minutes >= 360 && minutes <= 1079) return "1st Shift";  // 6:00 - 17:59
  return "2nd Shift";                                        // 18:00 - 5:59
}

/* Force shift filter to current shift */
function forceCurrentShiftFilter() {
  const cur = getCurrentShift();
  const normCur = normalize(cur);
  const opt = Array.from(shiftSelect.options).find(o => normalize(o.value) === normCur);
  if (opt) {
    shiftSelect.value = opt.value;
    selectedShift = opt.value;
    shiftSelect.disabled = true;
    for (const o of shiftSelect.options) o.style.fontWeight = (o === opt) ? "bold" : "normal";
  } else {
    const fallback = cur.replace(" Shift", "");
    const fb = Array.from(shiftSelect.options).find(o => normalize(o.value).includes(normalize(fallback)));
    if (fb) {
      shiftSelect.value = fb.value;
      selectedShift = fb.value;
      shiftSelect.disabled = true;
    }
  }
}

/* ===========================
   STATE & DOM REFERENCES
   ===========================
*/
let allData = [];
let crimeData = [];
let displayedMarkers = [];
let highlightLayer = null;
let selectedRowEl = null;
let personnelExpanded = false;
const imageCache = new Map();
const stationSelect = document.getElementById("stationFilter");
const shiftSelect = document.getElementById("shiftFilter");
const typeSelect = document.getElementById("typeFilter");
const crimeTbody = document.querySelector("#crimeTable tbody");
const personnelTbody= document.querySelector("#personnelTable tbody");
const loadingOverlay= document.getElementById("loadingOverlay");
const summaryBox = document.getElementById("summaryBox");
const toggleLink = document.getElementById("togglePersonnel");
const refreshBtn = document.getElementById("refreshBtn");

/* ===========================
   MAP INITIALIZATION
   ===========================
*/
const map = L.map('map').setView(defaultCenter, defaultZoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; PICTMU, NOrPPO, PRO NIR' }).addTo(map);

function addHighlight(latlng){
  try {
    if (highlightLayer && highlightLayer.getLatLng && highlightLayer.getLatLng().lat === latlng[0] && highlightLayer.getLatLng().lng === latlng[1]) return;
    if (highlightLayer) { map.removeLayer(highlightLayer); highlightLayer = null; }
    highlightLayer = L.circleMarker(latlng, {
      radius: 10, color: '#b8860b', weight: 3, fillColor: '#ffcc00', fillOpacity: 0.9, opacity: 1,
    }).addTo(map);
  } catch(e) { console.warn("[HIGHLIGHT] Error:", e); }
}

/* ===========================
   HELPERS
   ===========================
*/
function normalize(s){ return s ? String(s).trim().toLowerCase() : ""; }
function showLoading(on){ loadingOverlay.classList.toggle("active", !!on); }
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

function getField(row, ...keys) {
  if(!row) return "";
  for (const k of keys) {
    if (k in row && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") return row[k];
  }
  const actualKeys = Object.keys(row);
  for (const k of keys) {
    const target = String(k || "").trim().toLowerCase();
    for (const a of actualKeys) {
      if (String(a).trim().toLowerCase() === target) {
        if (row[a] !== undefined && row[a] !== null && String(row[a]).trim() !== "") return row[a];
      }
    }
  }
  for (const a of actualKeys) {
    const ak = String(a).toLowerCase();
    for (const k of keys) {
      if (ak.indexOf(String(k || "").trim().toLowerCase()) !== -1) {
        if (row[a] !== undefined && row[a] !== null && String(row[a]).trim() !== "") return row[a];
      }
    }
  }
  return "";
}

function parseLatLngFromRow(r){
  try {
    const tryVals = (keys) => {
      for(const k of keys){
        if(r[k] !== undefined && r[k] !== null && String(r[k]).trim()!=="") return String(r[k]).trim();
      }
      return "";
    };
    let combined = tryVals([
      "Latitude, Longitude: (e.g 9.336661, 123.305993) Note: Provide coordinates only in a high-precision DD format, using many decimal places. ",
      "Latitude, Longitude", "Lat_Long", "Lat_Long (e.g. 9.33805856, 123.3007679)", "Lat_Long (e.g. 9.33805856, 123.3007679",
      "LatLong", "Lat / Long", "Lat_Long ", "lat_long", "latlong", "Lat/Long", "Latitude_Longitude", "lat,lng", "Coordinates", "coords", "Location"
    ]);
    if(!combined) combined = getField(r, "Latitude, Longitude: (e.g 9.336661, 123.305993) Note: Provide coordinates only in a high-precision DD format, using many decimal places. ", "Latitude, Longitude", "Lat_Long (e.g. 9.33805856, 123.3007679)", "Lat_Long", "LatLong", "Coordinates", "coords", "Location");
    let latVal = tryVals(["Lat","Latitude","lat","latitude","LAT","Y"]);
    let lngVal = tryVals(["Lng","Long","Longitude","lng","long","longitude","LON","Lon","X"]);
    if(combined){
      const parts = combined.split(/[,;\/\s()]+/).map(p=>p.trim()).filter(Boolean);
      if(parts.length >= 2){
        const a = parseFloat(parts[0].replace(/[^\d\.\-]/g,'')), b = parseFloat(parts[1].replace(/[^\d\.\-]/g,''));
        if(!isNaN(a) && !isNaN(b)) return { lat: +a, lng: +b };
      }
    }
    if(latVal && latVal.indexOf(",") !== -1 && (!lngVal)){
      const ps = latVal.split(/[,;\/\s()]+/).map(p=>p.trim()).filter(Boolean);
      if(ps.length>=2){
        const a = parseFloat(ps[0]), b = parseFloat(ps[1]);
        if(!isNaN(a) && !isNaN(b)) { latVal = ps[0]; lngVal = ps[1]; }
      }
    }
    let lat = latVal ? parseFloat(latVal.replace(/[^\d\.\-]/g,'')) : NaN;
    let lng = lngVal ? parseFloat(lngVal.replace(/[^\d\.\-]/g,'')) : NaN;
    function inPHLat(v){ return !isNaN(v) && v >= 4 && v <= 22; }
    function inPHLng(v){ return !isNaN(v) && ( (v >= 116 && v <= 127) || (v <= -116 && v >= -127) ); }
    if(!isNaN(lat) && !isNaN(lng)){
      if(!inPHLat(lat) && inPHLat(lng) && !inPHLng(lng) && inPHLng(lat)){
        const tmp = lat; lat = lng; lng = tmp;
      }
    }
    if(isNaN(lat) || isNaN(lng)) return FALLBACK_COORDS;
    return { lat: +lat, lng: +lng };
  } catch(err) {
    console.error("[PARSE LATLNG] Error for row:", r, err);
    return FALLBACK_COORDS;
  }
}

function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

function makeContactLinks(mobile){
  const cleaned = (mobile||"").toString().replace(/\s+/g,'');
  if(!cleaned) return '';
  let plusNum = cleaned;
  if(/^0\d+/.test(cleaned)) plusNum = "+63" + cleaned.slice(1);
  if(/^\d{10,}$/.test(cleaned) && !/^\+/.test(plusNum)) plusNum = "+" + plusNum;
  const vlink = `viber://chat?number=${encodeURIComponent(plusNum)}`;
  const tel = `tel:${plusNum}`;
  return `<a class="viber-link" href="${vlink}" title="Open Viber">${escapeHtml(plusNum)}</a> <a href="${tel}" title="Call"></a>`;
}

/* ===========================
   CSV FETCH
   ===========================
*/
function fetchCsv(url){
  return fetch(url + (url.includes("?") ? "&" : "?") + "t=" + Date.now(), {cache: "no-store"})
    .then(r => {
      if(!r.ok) throw new Error("Network response not ok: " + r.status);
      return r.text();
    })
    .then(text => {
      console.log("[FETCH CSV] Successfully fetched:", url);
      return Papa.parse(text, { header: true, skipEmptyLines: true }).data;
    })
    .catch(err => {
      console.error("[FETCH CSV] Error fetching:", url, err);
      throw err;
    });
}

/* ===========================
   LOAD & NORMALIZE DATA
   ===========================
*/
async function loadData(){
  showLoading(true);
  console.log("[LOAD] Starting fetch of CSVs...");
  try{
    const [depRows, crimeRows] = await Promise.all([ fetchCsv(DEPLOYMENT_SHEET_CSV), fetchCsv(CRIME_SHEET_CSV) ]);
    console.log("[LOAD] CSVs fetched");

    allData = depRows.map((r, idx) => {
      const { lat, lng } = parseLatLngFromRow(r);
      const personnelFieldValue = getField(r,
        "Personnel: (e.g. Rank FName MI LName) Note: Put a comma after each item if you list more than one. ",
        "Personnel (Rank_FName_MI_LName)", "Personnel (Rank_FName_MI_LName (Contact#) ", "Personnel (Rank_FName_MI_LName (Contact#)", "Personnel", "Personnel (Rank_FName_MI_LName (Contact#) "
      );
      const personnelRaw = (personnelFieldValue || "").toString();
      const rawPersonnel = [];
      if (personnelRaw) {
        personnelRaw.split(",").map(p=>p.trim()).filter(Boolean).forEach(entry => {
          rawPersonnel.push({ name: entry, mobile: "" });
        });
      }
      const contactFieldValue = getField(r, "Contact Number: Note: Only the number of the team leader (or most senior member) is required. ", "Contact Number", "Mobile", "Mobile No", "Mobile#");
      const contact = (contactFieldValue || "").toString().trim();
      if (contact && rawPersonnel.length > 0) rawPersonnel[0].mobile = contact;

      const rowData = {
        raw: r,
        Station: getField(r, "Station/Unit", "Station -", "Station") || "Unknown",
        Shift: getField(r, "Duty Shift:", "Shift") || "Unspecified",
        "Deployment Type": getField(r, "Types Deployment:", "Deployment Type", "DeploymentType") || "Unspecified",
        Name: getField(r, "Name (Rank FName MI LName)", "Name") || (rawPersonnel.length > 0 ? rawPersonnel[0].name : "Unnamed"),
        CallSign: getField(r, "Call Sign:", "Call Sign", "CallSign") || "",
        Location: getField(r, "Deployment Area", "Location", "Location/Barangay") || "",
        Photo: getImageUrl(getField(r, "Picture with Timestamp:", "Picture with timestamp", "Photo", "Picture")),
        PersonnelList: rawPersonnel,
        Lat: lat,
        Lng: lng
      };
      return rowData;
    }).filter(d => d.Station !== "Unknown" || d.PersonnelList.length > 0);

    crimeData = crimeRows.map(r => ({
      Station: getField(r, "Station") || "Unknown",
      "Focus Crimes": getField(r, "Focus Crimes", "Crime") || "",
      Barangay: getField(r, "Barangay") || ""
    }));

    console.log("[LOAD] Parsed deployments:", allData.length);
    console.log("[LOAD] Calling refreshUI...");
    refreshUI();
    forceCurrentShiftFilter();   // <<< AUTO SET CURRENT SHIFT
    applyFilters();              // <<< DRAW ONLY CURRENT SHIFT
  } catch(err){
    console.error("[LOAD] Error loading CSVs or parsing data:", err);
  } finally {
    showLoading(false);
    console.log("[LOAD] Completed");
  }
}

/* ===========================
   REFRESH UI
   ===========================
*/
function refreshUI(){
  try {
    const stationSet = [...new Set(allData.map(d => d.Station).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    stationSelect.innerHTML = "<option value='All'>All</option>" + stationSet.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

    // Populate shift dropdown with all shifts from data
    const allShifts = [...new Set(allData.map(d => d.Shift).filter(Boolean))].sort();
    shiftSelect.innerHTML = "<option value='All'>All</option>" + allShifts.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    shiftSelect.disabled = true;

    typeSelect.innerHTML = "<option value='All'>All</option>"; typeSelect.disabled = true;

    selectedStation = "All"; selectedShift = "All"; selectedType = "All";
    displayedMarkers.forEach(m => { try{ map.removeLayer(m.marker); } catch(e){} });
    displayedMarkers = [];
  } catch(err) {
    console.error("[REFRESH UI] Error:", err);
  }
}

/* ===========================
   APPLY FILTERS
   ===========================
*/
let selectedStation = "All", selectedShift = "All", selectedType = "All";

function applyFilters(){
  try {
    showLoading(true);
    const filtered = allData.filter(d =>
      (selectedStation === "All" || normalize(d.Station) === normalize(selectedStation)) &&
      (selectedShift   === "All" || normalize(d.Shift)   === normalize(selectedShift)) &&
      (selectedType    === "All" || normalize(d["Deployment Type"]) === normalize(selectedType))
    );

    displayedMarkers.forEach(mset => { try{ map.removeLayer(mset.marker); } catch(e){} });
    displayedMarkers = [];

    const bounds = [];
    filtered.forEach((r, idx) => {
      const lat = r.Lat != null ? r.Lat : FALLBACK_COORDS.lat;
      const lng = r.Lng != null ? r.Lng : FALLBACK_COORDS.lng;
      const photoUrl = r.Photo || FALLBACK_TEST_IMAGE;
      const imgSrc = imageCache.get(photoUrl) || photoUrl;

      const popupDiv = document.createElement('div');
      popupDiv.className = 'popup-card';
     
      const header = document.createElement('div');
      header.className = 'popup-header';
      const h3 = document.createElement('h3');
      h3.textContent = r.Station || 'Unknown Unit';
      header.appendChild(h3);
      popupDiv.appendChild(header);

      if (r.Location) {
        const row = document.createElement('div');
        row.className = 'popup-row';
        row.innerHTML = `<b>Patrol Area:</b> ${escapeHtml(r.Location)}`;
        popupDiv.appendChild(row);
      }
      if (r.Shift) {
        const row = document.createElement('div');
        row.className = 'popup-row';
        row.innerHTML = `<b>Shift:</b> ${escapeHtml(r.Shift)}`;
        popupDiv.appendChild(row);
      }
      if (r["Deployment Type"]) {
        const row = document.createElement('div');
        row.className = 'popup-row';
        row.innerHTML = `<b>Deployment:</b> ${escapeHtml(r["Deployment Type"])}`;
        popupDiv.appendChild(row);
      }
      if (r.CallSign) {
        const callsign = document.createElement('span');
        callsign.className = 'popup-callsign';
        callsign.innerHTML = `<b>Callsign</b>: ${escapeHtml(r.CallSign)}`;
        popupDiv.appendChild(callsign);
      }
      const hr = document.createElement('hr');
      popupDiv.appendChild(hr);

      const peopleDiv = document.createElement('div');
      peopleDiv.className = 'popup-people';
      if (Array.isArray(r.PersonnelList) && r.PersonnelList.length) {
        r.PersonnelList.forEach((p, idx) => {
          const personDiv = document.createElement('div');
          personDiv.className = 'popup-person';
          const name = p.name || r.Name || ("Person " + (idx+1));
          const mobile = p.mobile || "";
          const nameSpan = document.createElement('span');
          nameSpan.className = 'person-name';
          nameSpan.textContent = name;
          personDiv.appendChild(nameSpan);
          personDiv.appendChild(document.createElement('br'));
          personDiv.innerHTML += mobile ? makeContactLinks(mobile) : `<span style="opacity:0.6">no mobile</span>`;
          peopleDiv.appendChild(personDiv);
        });
      } else {
        const personDiv = document.createElement('div');
        personDiv.className = 'popup-person';
        personDiv.innerHTML = `<strong>${escapeHtml(r.Name || "Unnamed")}</strong>`;
        peopleDiv.appendChild(personDiv);
      }
      popupDiv.appendChild(peopleDiv);

      const photoDiv = document.createElement('div');
      photoDiv.className = 'popup-photo loading';
      const img = document.createElement('img');
      img.src = imgSrc;
      img.alt = 'photo';
      img.width = 250;
      img.height = 120;
      img.onload = () => { photoDiv.classList.remove('loading'); };
      img.onerror = () => { img.src = STATIC_TEST_IMAGE; img.width = 250; img.height = 120; photoDiv.classList.remove('loading'); };
      photoDiv.appendChild(img);
      popupDiv.appendChild(photoDiv);

      const deploymentType = r["Deployment Type"] || "default";
      let icon = ICONS[deploymentType] || ICONS["default"];
      const iconImg = new Image();
      iconImg.src = icon.options.iconUrl;
      iconImg.onload = () => {};
      iconImg.onerror = () => { icon = FALLBACK_ICON; };

      const marker = L.marker([lat, lng], { icon });
      marker.bindPopup(popupDiv, { maxWidth: 400, minWidth: 250, className: "custom-popup", autoClose: false, keepInView: true });
      marker.addTo(map);
      displayedMarkers.push({ marker, deployment: r });
      bounds.push([lat, lng]);
    });

    if(bounds.length){
      if (selectedStation !== "All") {
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.2));
      } else {
        map.setView(defaultCenter, defaultZoom);
      }
    } else {
      map.setView(defaultCenter, defaultZoom);
    }

    renderPersonnelTable(filtered);
    renderCrimeTable();
    updateSummaryBox(filtered);
    showLoading(false);
  } catch(err) {
    console.error("[FILTER] Error applying filters:", err);
    showLoading(false);
  }
}

/* ===========================
   RENDER TABLES & SUMMARY
   ===========================
*/
function renderPersonnelTable(filteredDeployments){
  personnelTbody.innerHTML = "";
  if (!selectedStation || selectedStation === "All") {
    personnelTbody.innerHTML = `<tr><td colspan="4" style="padding:8px; color:#aaa; font-style:italic; text-align:center;">Please select a station to show personnel list here</td></tr>`;
    toggleLink.style.display = "none";
    return;
  }
  const personRows = [];
  filteredDeployments.forEach(dep => {
    if(Array.isArray(dep.PersonnelList) && dep.PersonnelList.length){
      const combinedNames = dep.PersonnelList.map(p => p.name || "").filter(Boolean).join(", ");
      const firstMobile = (dep.PersonnelList.find(p => p.mobile) || {}).mobile || "";
      personRows.push({ name: combinedNames || dep.Name || "Unnamed", mobile: firstMobile, CallSign: dep.CallSign || "", Station: dep.Station || "Unknown", lat: dep.Lat, lng: dep.Lng, deployment: dep });
    } else {
      personRows.push({ name: dep.Name || "Unnamed", mobile: (dep.raw && (dep.raw.Mobile || dep.raw["Mobile No"] || dep.raw["Mobile#"])) || "", CallSign: dep.CallSign || "", Station: dep.Station || "Unknown", lat: dep.Lat, lng: dep.Lng, deployment: dep });
    }
  });
  if(personRows.length === 0){
    personnelTbody.innerHTML = "<tr><td colspan='4'>No personnel</td></tr>";
    toggleLink.style.display = "none";
    return;
  }
  const visible = personnelExpanded ? personRows : personRows.slice(0, 5);
  const handleRowClick = debounce((p, tr, ev) => {
    if (selectedRowEl) selectedRowEl.classList.remove("selected");
    tr.className = "person-row selected";
    selectedRowEl = tr;
    const match = displayedMarkers.find(m => m.deployment === p.deployment);
    if (match) {
      map.flyTo(match.marker.getLatLng(), 15, { animate: true, duration: 0.3 });
      match.marker.openPopup();
      addHighlight([match.deployment.Lat || FALLBACK_COORDS.lat, match.deployment.Lng || FALLBACK_COORDS.lng]);
    }
  }, 300);
  visible.forEach((p, idx) => {
    const tr = document.createElement("tr");
    tr.className = "person-row";
    const mobileCell = p.mobile ? `<td>${makeContactLinks(p.mobile)}</td>` : `<td><span style="opacity:0.6">no mobile</span></td>`;
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td>${mobileCell}<td>${escapeHtml(p.CallSign)}</td><td>${escapeHtml(p.Station)}</td>`;
    tr.onclick = ev => handleRowClick(p, tr, ev);
    personnelTbody.appendChild(tr);
  });
  toggleLink.style.display = personRows.length > 5 ? "inline-block" : "none";
  toggleLink.textContent = personnelExpanded ? "Show less" : `Show more (${personRows.length})`;
}

function renderCrimeTable(){ /* unchanged */ }
function updateSummaryBox(filteredRows){ /* unchanged */ }

/* ===========================
   FILTER EVENT HANDLERS
   ===========================
*/
stationSelect.onchange = function(){
  selectedStation = stationSelect.value;
  selectedShift = "All"; selectedType = "All";

  if(selectedStation === "All"){
    shiftSelect.innerHTML = "<option value='All'>All</option>"; shiftSelect.disabled = true;
    typeSelect.innerHTML = "<option value='All'>All</option>"; typeSelect.disabled = true;
  } else {
    const stationRows = allData.filter(d => normalize(d.Station) === normalize(selectedStation));
    const shifts = [...new Set(stationRows.map(r => r.Shift || "Unspecified"))];
    const types  = [...new Set(stationRows.map(r => r["Deployment Type"] || "Unspecified"))];
    shiftSelect.innerHTML = "<option value='All'>All</option>" + shifts.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    typeSelect.innerHTML  = "<option value='All'>All</option>" + types.map(t =>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    shiftSelect.disabled = false; typeSelect.disabled = false;
  }
  forceCurrentShiftFilter();  // re-apply current shift
  applyFilters();
};

shiftSelect.onchange = function(){
  selectedShift = shiftSelect.value;
  for (const o of shiftSelect.options) o.style.fontWeight = "normal";
  if (shiftSelect.selectedOptions[0]) shiftSelect.selectedOptions[0].style.fontWeight = "bold";
  applyFilters();
};

typeSelect.onchange = function(){
  selectedType = typeSelect.value;
  applyFilters();
};

toggleLink.onclick = function(){
  personnelExpanded = !personnelExpanded;
  applyFilters();
};

refreshBtn.onclick = function(){
  selectedStation="All"; selectedShift="All"; selectedType="All";
  stationSelect.value="All"; shiftSelect.value="All"; typeSelect.value="All";
  map.setView(defaultCenter, defaultZoom);
  loadData();
};

/* ===========================
   INITIAL LOAD
   ===========================
*/
loadData();

/* Auto refresh every 10 minutes */
setInterval(() => { console.log("[AUTO REFRESH]"); loadData(); }, 600000);

/* Security */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || (e.ctrlKey && e.keyCode === 85)) {
    e.preventDefault(); return false;
  }
});
</script>
</body>
</html>
